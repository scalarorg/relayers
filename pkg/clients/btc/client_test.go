package btc_test

import (
	"encoding/base64"
	"encoding/hex"
	"fmt"
	"os"
	"strings"
	"testing"

	utils "github.com/scalarorg/go-common/types"
	"github.com/scalarorg/relayers/config"
	"github.com/scalarorg/relayers/pkg/clients/btc"
	"github.com/scalarorg/relayers/pkg/db"
	"github.com/scalarorg/relayers/pkg/events"
	"github.com/scalarorg/relayers/pkg/types"
	covTypes "github.com/scalarorg/scalar-core/x/covenant/types"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

var (
	TAPROOT_ADDRESS string = "tb1p07q440mdl4uyywns325dk8pvjphwety3psp4zvkngtjf3z3hhr2sfar3hv"
	btcClient       *btc.BtcClient
	globalConfig    *config.Config
	btcConfig       *btc.BtcNetworkConfig
	dbAdapter       *db.DatabaseAdapter
	eventBus        *events.EventBus
	rawTx           string = "0200000000010a52c0173d62c0c6a79ab2da183f059580fd996c24727894d3e0f6cf36a3cb77730000000000ffffffffbe74ea7a7b0ec95ca84cf726f233ffa6c3efd6db21626ae9a833d0ff92ef44230000000000ffffffff1db1d2a3d81b4b6d8567292713eb423ce2070c57d4be0f1f7fbe1d2be5ffe21c0000000000ffffffff9bf092707c14290b7846ad72ec46efb08a1fa29620b69fdf7eb94f18b77de4e50000000000ffffffffda4a02435a6eaf7f861f775422ed7f972c057bfafe98a2b9f6b22c5824945d0b0000000000fffffffff00b84fff35f4eae205480f39d91ac130646eb86fce1be47d9b7abec0271b1100000000000ffffffff756b1503e232d68ab43474af17ae9f2aa860649b3571fda65bb6b068724d4e320000000000ffffffff5a9d2b3a334ca36d9accd1114dde5180f60acca4770d5dfa970efdbd3194d3360000000000ffffffffc5dfd4279fc725fefbb1090614e62a757db1b3fb8def563d6318a8ed9f15dd4d0000000000ffffffff44a6ffe23559e791ffa1c4c560795003aa5830e41a59341df0d0e3e645f4916d0000000000ffffffff030000000000000000106a0e5343414c4152010141706f6f6c73102700000000000016001450dceca158a9c872eb405d52293d351110572c9e10f7070000000000225120a8fc50d87f16d892b4d4d087d259c0ab417e106b044b291a7728d2ae1343de7f06409d08e9513d47ae3ab5ebf381e3ef2a1da1ec5d25f251786df5b1fea0f08d534e7b27cd886157d986e9e363345574f7a402a5da9e8acf6cc26089f2791f7dfd5140bdb7be103348981f3b49ad5c8718d2741c84161dca8cead3a87210aa8a4f4d4456b5e5bf4326433ac90f4e76ef8a7968189d45b284378e028886a2392099e6e840f1bb5bd48b85b48de56e3095636a1a2cecb6dfca47ee9dfcbc7830ae8e0d33297ac5f6531f8d71ff1104ca424e5ef59138d0b1bd22b8bcf5a3d23f7dd97d06654028ebd85edce00b0a972efc0a33ada78e9db4eb841ad090a4d05ceb89a7d4b3afb616962c59b6ce4b3491c9687de71ed1596e356de3f90de2014595d8b082d3998a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac00640eb9eee61a713dd3c7771330e8b845860173c4b9a2273ec7864e221c7287218d09b7cceede96d59bb937ed14dd47389ba9ee4d317d02d4711e90ef67e782830534053fd07220784b9b0ea9be4491e3b851fa30fef1d7872b0b9c8775ccd89d9cff56fa79b608291e5a134833e70a89566dc7be87d6261a54220e84fe11d5c774e2c40f35df4459c490328e58afd9f5f2afb25fc69c901d52bd096d94c109d678a1df58b8617ed4948d5571db9da679e647760da7fa9c29dfe2b9f363d8cabb85ec284408034e64205d12f2f128e928223f582b9cde66956c407752dbfd368c58f4d24389207f8cbf92e00b773182ee6fec0f59252b1c6d5e0c89588158fa70070f379928a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac00640e1e02c2edfc06725a6b28087e76e900e170ee4342930c7a8c98ab8884fe8f1b25f19f36f9b1b7653603ef24f1383db7251f84695f12115bc7894cc536cac82f240d3ddfb95939c7047ae3dda40195d327ff687a2a7a02b0bf8bdd90f8a217a61b50c80ac1b8624949cd7dda4b93ac9e0c0ff5fcaa90350adb93c04399f279fa9b44032907244a850efc5de2a30b33ba647904252170dab77e01ca45c851f6b81797c27758ad9b88a5bcdb3db3487570687d8186aa470a96d448724e59ee286dcca6e40ae9bfcda4ca804bf1f61c30f2ec84025d88e2cce1d2a38db1ce1e2df46d8ac7b51aca47b3da312f19951d7342baef9ed6d02ce9ae5a25fa6ecaacd03b77fa9fb8a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0064000ee3f2d9670937548942dd21fb6606006eee4d2997ac2bc92a005619815b38484cdcebbdaf1984b2e825b8e11cbcb10426df0b877b6377f7f4290c022de34a64061dffa90bb89e0a95857027d9cf41121f45e49d98c263c0c2089ebec5736a6ba9b32561fc4b0fe52dd020790c1063c8ac2d0b1a9c1dc4ab9e35cb20b773cd61f40f86a5f0966f2e5f9011af9877c184fbdba7bfd27d36707b2b6bde91b7be357a94b9a8905a76f6a943fb5820a579e41080871a0fcf57f6c222a732913f71c2cc7406e33a0f193081d3ae5c7fe2846fe046ed688b6278a72b3e42cb6d1052b9cbc8c992c11421f34f021508a93e318d7c2343a8d4e534bedb59f43518ac972c9aebc8a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0064016c60f04fc272288a247f2f9cc9d4fcc2ef21b465a48207e3b0994610a4fe30551ffe718bf907a12cb0cc33fd8f9b1b83c8e3ab8922e261125817c0bc66df1b440b107a8a1927545ed84f5c9aabc78d3047ec4810d62198ef7715bee104b6b9f749a53a8f3b28202e174c44e441a054bc39f25da671d300276d8f2727e8fddaf4d40ca84978d4ea04d8c24471fc821f0864ee99e0da7f3b64847101a22534a1a0f797420262778b8b8b3742c97da788429c38417e0e738a6bc55af22f1f69989df6c4058a050762754ee880f4eeab50889ee77822b827a6155c4686320d7a1d8a446516389f4ddbae5f2d0bdd10a91bb8e6b87f7396bed69fc95d21f2a416da6ff41978a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac00640ebc87b7f9860b22627c6979ffab2ea4ea27ae40d76992c387912c573bca6e117f2df31982258343c3c83855cfc0bec2bbc6cc09afca8b02e5342b6a586767160406c42ea0a93c17e26d2b4c0894f220f55747320d91951f8056c60cd4939f9a7f214e98244abe637e1e6948fafe578262138e8a85995eb44ad3eb9565325f0636b40f1c06a082284e59477f56e92c5d2ed2718660f31e7c56565285823d81ed47563b572ea299752e56ce2eab0748c6a50863b71af0528188d86d7ea327abef9acde408fa13785b28347f8ee4dbafa1e08b8d4a18f46f9ba609a5e7468b4f3d60a551caa0c53bc1df34af78f226c6319b79cb58cbe663e746d7eae74e33d40bf0622368a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac00640f9859838981e73551465b5a381dfbf3ebcfe0937ce382bb856f84d4680d0084d9e5da078f14a50f0f4671d4e5f16fe2b20ddbe2817006ff7daa22b222adbd67040f20fafdfc5950984da6254c802ef332b5dad6357392db35a9850b3d34455e06f0d40f692f9e431432f7b2ef8dc5311bb5e19249da91c7f51840910384e6fa7b940104cf59dc7da53770731d08b8e98c963f86f05335b7fe64b852f2065187c1c32fae3eb66f9d68f64cb49068b1cd64c7c22cee2e82be6e48951a59a2121022d1340ef2c2ae8df359105a44cc6bd74e15c5573de7c20f0941f7f2e359c3c2ebfb0b37d180c45b84a2695c014eb991e9c62d71c67dfb54e31d1716e8dc124f2c3021e8a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac00640b685a0f25468c1f163c4a453382e2ac7ebcadcd0a51337aef268fcfcf115d55569efb908f51bbcc944f09358d48bfb39c3ad527156a84d86747748c5f435aea440eded78908ad27e51f926f88e3a1a057026833560b0e9ee62bb9c092f840c8e93dce8b1c7bc987e1d8835d652c24df12de5e33af9719c8a6d690b9bbc0b6a622a40493a8fcb46c250afc6370621cfb2bb73e66617f94b6933eceab41f7a02e40b1583ac7a13904c365b7547b61257aec840ebfd9957907f2354401ce047b52f619c401e881291db1d8bcd08791d403fb5d8f4cf16b2dc7b522dba1b4e4b4124bf04f8c18f7f0331a17a4c7faaf92ab76883596adb07149a169d9836c8a99e524951278a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0064066a5ea8dab0032f292ad38bc94a71d1d0a38271bd7f7b7f678eeb54cb547a1ef0733e6065227264aaea3a345fd24cb63021af21fd9d50777cc0cc1d0ccd7859b401a07baa3aec267840dd7c3834ab95cbc86081063c2c040c3eb5eaea4bda69f2894981a2f5a0413d760a127d7ce79a1e8e6b4469e8e4f649fabfd797d7701d15f405cb054b060da1252389cbf94363b0518316dddf383ac889f55880a650e9fba5e56583a816e92109011c99747da7d52c078416df3eda26d716a00e06ccfb579bf40b42e457f907bbdb8fed71bcca7cea1c4f381a81a0986068c7b1a925f6143cddf2632da2385bdc3e5a532fcd5ddee7c0eb14dcd9774a0efbc7d46ec92829f60488a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0064092370d302a9785ce8c325aa6bd072b19dbd498cdc931a1748ba37c8906a65cfaa07ccbc6c7a2eaa20523d92198f0ee9123ec1af49c44fcd0e1ecbb43aaa493ab40eb73cee4a788385b7c5d4ab5dad9e63d0c44adc9a0b0b483c9a10973735066884bd543065137b3424af67c531f3b65910fa20e4b375dce2a21f94eb62bb2e77940a1e5cd77fa73eabd2734be853a5b87dd8438e34df8315d954cc6eb6c42c580015f7f198d009e19fabf82df4a3c4947342c51abf32366038772aac9175b35086240d9b5655b8a69697efac8abc1d7c0b58e8d91146c6b8b2f0166963a090f9702daa190cc9a6caafc89d77b1b30509f22896e2de1e1e7f8c8719cb8328c68df253c8a2015da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488ac20594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811ba20b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102ba20f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5ba53a221c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac000000000"
)

var pubkeys = []string{
	"0215da913b3e87b4932b1e1b87d9667c28e7250aa0ed60b3a31095f541e1641488",
	"02f0f3d9beaf7a3945bcaa147e041ae1d5ca029bde7e40d8251f0783d6ecbe8fb5",
	"03594e78c0a2968210d9c1550d4ad31b03d5e4b9659cf2f67842483bb3c2bb7811",
	"03b59e575cef873ea95273afd55956c84590507200d410e693e4b079a426cc6102",
	"03e2d226cfdaec93903c3f3b81a01a81b19137627cb26e621a0afb7bcd6efbcfff",
}

func TestMain(m *testing.M) {
	globalConfig = &config.Config{}
	btcConfig = &btc.BtcNetworkConfig{
		Name:       "test",
		Host:       "testnet4.btc.scalar.org",
		Port:       80,
		User:       "scalar",
		Password:   "scalartestnet4",
		SSL:        nil,
		MempoolUrl: "https://mempool.space/testnet4/api",
		Address:    &TAPROOT_ADDRESS,
	}
	btcClient, _ = btc.NewBtcClientFromConfig(
		globalConfig,
		btcConfig,
		dbAdapter,
		eventBus,
		nil,
	)
	os.Exit(m.Run())
}

// CGO_LDFLAGS="-L./lib -lbitcoin_vault_ffi" CGO_CFLAGS="-I./lib" go test -timeout 10m -run ^TestGetTxOutUtxo$ github.com/scalarorg/relayers/pkg/clients/btc -v -count=1
// curl --user scalar --data-binary '{"jsonrpc": "1.0", "id": "curltest", "method": "gettxout", "params": ["1c1fe66b53c9994a27436a67afbe68fd5e0445aedc7cc01d787a4bb911486dbd", 0]}' -H 'content-type: text/plain;' http://testnet4.btc.scalar.org/
func TestGetTxOutUtxo(t *testing.T) {
	utxos, err := btcClient.GetListOfUTXOs("tb1q2rwweg2c48y8966qt4fzj0f4zyg9wty7tykzwg")
	fmt.Println("%w", err)
	assert.NoError(t, err)
	assert.NotEmpty(t, utxos)
	for _, utxo := range utxos {
		fmt.Println(utxo.Txid, utxo.Vout, utxo.Value)
		txOut, err := btcClient.GetTxOut(utxo.Txid, utxo.Vout)
		fmt.Printf("txOut: %+v, err: %v\n", txOut, err)
		require.NoError(t, err)
		require.NotNil(t, txOut)
	}

	payload := "0000000000000000000000000000000000000000000000000000000000000003E800000000000000000000000000000000000000000000000000000000000000C0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000020085FEF9623731168B1EDF1D09C28064818A086C7F867747C81D54C3548F4A19D30000000000000000000000000000000000000000000000000000000000000016001450DCECA158A9C872EB405D52293D351110572C9E0000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004230783733373763626133333663666636653064333934373837323234366339396664383039353035336631386461623239616137633663303632336431376330353200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003E8"
	payloadBytes, err := hex.DecodeString(payload)
	require.NoError(t, err)
	params := covTypes.RedeemTokenPayloadWithType{}
	err = params.AbiUnpack(payloadBytes)
	require.NoError(t, err)
	t.Logf("params: %+v", params)
	txHash := params.Utxos[0].TxID.Hex()
	vout := params.Utxos[0].Vout
	t.Logf("params.TokenId: %s, vout: %d", txHash, vout)
	txOut, err := btcClient.GetTxOut(strings.TrimPrefix(txHash, "0x"), vout)
	fmt.Printf("txOut: %+v, err: %v\n", txOut, err)
	assert.Error(t, err)
	assert.Nil(t, txOut)
}

// CGO_LDFLAGS="-L./lib -lbitcoin_vault_ffi" CGO_CFLAGS="-I./lib" go test -timeout 10m -run ^TestGetUtxtSnapshot$ github.com/scalarorg/relayers/pkg/clients/btc -v -count=1
func TestGetUtxtSnapshot(t *testing.T) {
	taprootAddress := "tb1p4r79pkrlzmvf9dx56zraykwq4dqhuyrtq39jjxnh9rf2uy6rmelspm6j23"
	utxos, err := btcClient.GetListOfUTXOs(taprootAddress)
	assert.NoError(t, err)
	assert.NotEmpty(t, utxos)
	utxos = btc.SortUTXOsByBlockHeight(utxos)
	for _, utxo := range utxos {
		fmt.Println(utxo.Status.BlockHeight, utxo.Txid, utxo.Vout, utxo.Value)
	}
	fmt.Println("--------------------------------")
	utxos, err = btcClient.GetListOfUTXOs(taprootAddress)
	assert.NoError(t, err)
	assert.NotEmpty(t, utxos)
	utxos = btc.SortUTXOsByBlockHeight(utxos)
	for _, utxo := range utxos {
		fmt.Println(utxo.Status.BlockHeight, utxo.Txid, utxo.Vout, utxo.Value)
	}
}

// CGO_LDFLAGS="-L./lib -lbitcoin_vault_ffi" CGO_CFLAGS="-I./lib" go test -timeout 10m -run ^TestGetAddressTxsUtxo$ github.com/scalarorg/relayers/pkg/clients/btc -v -count=1
func TestGetAddressTxsUtxo(t *testing.T) {
	utxos, err := btcClient.GetAddressTxsUtxo(TAPROOT_ADDRESS, 200000)
	assert.NoError(t, err)
	assert.NotEmpty(t, utxos)
}

func TestMempoolRawTx(t *testing.T) {
	tx, err := btcClient.TestMempoolRawTx(rawTx)
	assert.NoError(t, err)
	assert.NotEmpty(t, tx)
}

// CGO_LDFLAGS="-L./lib -lbitcoin_vault_ffi" CGO_CFLAGS="-I./lib" go test -timeout 10m -run ^TestCreatePsbts$ github.com/scalarorg/relayers/pkg/clients/btc -v -count=1
func TestCreatePsbts(t *testing.T) {
	covScript, _ := hex.DecodeString("51207f815abf6dfd78423a708aa8db1c2c906eecac910c035132d342e4988a37b8d5")

	custodianPubKeys := []utils.PublicKey{}

	for _, pubkey := range pubkeys {
		p, _ := hex.DecodeString(pubkey)
		custodianPubKeys = append(custodianPubKeys, utils.PublicKey(p))
	}

	psbtParams := types.PsbtParams{
		ScalarTag:       []byte("SC4L4R"),
		Version:         0,
		ProtocolTag:     []byte("tPepe"),
		NetworkKind:     utils.NetworkKind(1), //testnet
		NetworkType:     "testnet4",
		CustodianPubKey: custodianPubKeys,
		CustodianQuorum: 3,
		CustodianScript: covScript,
	}

	lockingScript, _ := hex.DecodeString("001450dceca158a9c872eb405d52293d351110572c9e")

	outpoints := []types.CommandOutPoint{
		{
			BTCFeeOpts: 0,
			RBF:        false,
			OutPoint:   utils.UnlockingOutput{Amount: 10_000, LockingScript: lockingScript},
		},
	}

	psbts, err := btcClient.CreatePsbts(psbtParams, outpoints)
	for _, psbt := range psbts {
		fmt.Printf("psbt: %x\n\n\n", psbt)
		psbtStr := base64.StdEncoding.EncodeToString(psbt)
		fmt.Printf("base64: %s\n", psbtStr)
	}
	assert.NoError(t, err)
	assert.NotEmpty(t, psbts)
}
