package evm_test

import (
	"context"
	"fmt"
	"math/big"
	"os"
	"testing"
	"time"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/ethereum/go-ethereum/rpc"
	"github.com/joho/godotenv"
	"github.com/rs/zerolog/log"
	"github.com/scalarorg/data-models/scalarnet"
	"github.com/scalarorg/relayers/config"
	"github.com/scalarorg/relayers/pkg/clients/evm"
	contracts "github.com/scalarorg/relayers/pkg/clients/evm/contracts/generated"
	"github.com/scalarorg/relayers/pkg/db"
	"github.com/scalarorg/relayers/pkg/events"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

const (
	CHAIN_ID_SEPOLIA = "evm|11155111"
	CHAIN_ID_BNB     = "evm|97"
	TOKEN_SYMBOL     = "pBtc"
	PAYLOAD          = "09c5eabe00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000032c000000000000000000000000000000000000000000000000000000000000032600000000000000000000000000000000000000000000000000000000000aa36a70000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000012c0000000000000000000000000000000000000000000000000000000000000002455bef350f2157a165b0100e050736f2fa3c9fad3f92cc0eb3b6c991b79bd8e0b58f93abc701d55f690c01ee1403736a6a14b7284aeeacccb8e22ba92f39cce0a601d745ae6426c8335aca5eae6aca667b4daafb96384abb0afe948afb5c2c95e7b899ba83c82e44b54c6d83712f34b401156c3689ac2d0bacf8652c7aa35fc399885215899053d80f23ece648442e03b3f5f606440f067173636649e5e88b4acd178757d0325bc694f211d27d0be26b4a393b1c96595ef7ee32b02ac85c4730609759cc6e2936fa9b61c14ec050a2817e2c1173d79f7d9980d5d029d9d5a668548fcb3a2b2ba272d34775ad397bdfe42ea6123746fec3758071eb2297fb9911a4b6316f58a3b8abcee4689047103fac27be52b46bcdead5ffdfa15ead599026e50a24f30928222fbdd72b80bccfda6ac3d4b55838f7419f9b5053eb370b2d039534fc9d89156cf73b842aa1c43fb8b88a73682584fb7d9d24b9a9d1f1ceb9961570e9aaea97385d776c915891cc4b19f7ae457aeeca74a6a30eb383962d3b97d6d5c9f687f908d763bf90b0e3532a3eeeb16d303169ca3e0dd6959c2d81aa1c498a3cfcbd6984dc2c862be6ce8efe0f2638055f891b9d68833b1251f7aa9109dac7aa26020468029874e5ef53d20cd828cab890835671c2586bb92a005a7f1b2b5a7101e42fcdd3f93474e27d526d86b4e9829cf1251524394b8418523609722b74e656984036aacc9e39923d1e63e9e77d2b568b14f2091e17ea8804074dd62bb93bfb49c40eac30cf8be615fb9edf8cefc03a28de753add6f4101d70e8ef4fd98f981b24e7189f20a46ee780b9395a3997b65de36bf050820b11cf2d23c591d9e55658cb3794be9766b000c2c3855061090522405e10430cb548c3a8ade204dbc102302e9f3584f23b5a47c8335718f99910c11d688d08d080eba5164e9510e4626c4489470391384bb79b5e5b8f4b0decf65d441fd8b3251163ed1e7a9926eea10adbf2264f8b1119d5c294326af55d40f3356206ae4af7d8359752e57a9ef08de22b1020bff455a3760e4391bc304c51ae9451571a45af186aa973385d88f5754291e5fd0fa0de8cf0ed4a97e41d8e7c692966ff593f08275c292adfe4550cd661fcf3582508f258e09c20f96bde6c14801027a2656a40ca0a7baeeba9f32283efc30958556e279202a1f0a0b822f1b8b994d3ee16a17d9650f4b0f126d630823aec6d06ed2ae39f5d2001b73e16a9457c70754555cdded55de6d517f7b048da83f624c4f822f652c83e6137fad6656c5b61a010379b1f027ff768943df953331b9baa93fb398136a7b932e717a2f4a773f44b884c10290e41098abb4bf2737b96f001e26a44d6009a262c0f02cf717a381a9cb271b160206d8612e11aab77e97f9c2318d849eead449840ba300da4392ade482b8ad0c67d2f78ffd8549a865fb2efc47857d8237fdb74ce383a2228b0623b6c9309fe7e2f0d9b316621ef8e6a40f1e5779ca58380bc851e98a4c3c1675e407c08c9dace2f10e8f630ff97bfe7f5285946cf9a26ed5a6b6b7d2c441f5e341893e0220d78293cd608a1b8d4caae04c8f0b0fc4766ba72aea07e005904051b580551f6327d0e4ec6a19213e40000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000048000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000006c000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000740000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000007c000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000008c000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000000000000000000000000098000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000bc00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000d4000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000006c000000000000000000000000000000000000000000000000000000000000007800000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d800000000000000000000000000000000000000000000000000000000000000e400000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000fc000000000000000000000000000000000000000000000000000000000000010800000000000000000000000000000000000000000000000000000000000001140000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000012c000000000000000000000000000000000000000000000000000000000000013800000000000000000000000000000000000000000000000000000000000001440000000000000000000000000000000000000000000000000000000000000150000000000000000000000000000000000000000000000000000000000000015c000000000000000000000000000000000000000000000000000000000000016800000000000000000000000000000000000000000000000000000000000001740000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000018c000000000000000000000000000000000000000000000000000000000000019800000000000000000000000000000000000000000000000000000000000001a400000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000001bc00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000001d400000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000001ec000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a64521e0498d452065bce60dfe4f0ca3361227e00000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000df0aefe0cc8d54c9f3f63a6d40eda1e79987ba7e00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000e3ad978ef26858bdf46ad3f35860f25729f3490200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000e62870f158eda4553114a9a8c483c0b49e7a6b8100000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000710c55e17cd496be73ff864ff6b9de44d848ab3000000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a36c2c793259092beb19189b9ddff47b8fe5a46300000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a32df615f632bf5ebbf36c182db7e438aa9cd1a00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007434e0df36a707c7f94aa55917962448e1cec7d800000000000000000000000000000000000000000000000000000000000023280000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa0000000000000000000000000000000000000000000000000000000000000d9a0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fcd58512bd3e465a19f99a9c072b3ad6117395d200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b0000000000000000000000000000000000000000000000000000000000001b340000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a32df615f632bf5ebbf36c182db7e438aa9cd1a00000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000582dd2d558a1a0626f47b5b50a44d403359d61a300000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fcd58512bd3e465a19f99a9c072b3ad6117395d200000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000456b707a24bf46ef6d4582d07cffd45340718aaf00000000000000000000000000000000000000000000000000000000000007d00000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b62bc77dc17290c709fa88e491ddc3321a6a2ed400000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004fab6cb4c6e8b72f1529eda3e71f45127a85d4440000000000000000000000000000000000000000000000000000000000002f9b0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d0000000000000000000000000000000000000000000000000000000000000d9a0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000582dd2d558a1a0626f47b5b50a44d403359d61a300000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004fab6cb4c6e8b72f1529eda3e71f45127a85d4440000000000000000000000000000000000000000000000000000000000000d9a0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b62bc77dc17290c709fa88e491ddc3321a6a2ed40000000000000000000000000000000000000000000000000000000000000d9a00000000000000000000000000000000000000000000000000000000000000047442746300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000177000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000040000000000000000000000001ad5e55e61ac27b9f9e2f2517892871b12692e760000000000000000000000003114bec56527c45d782ebfa715d26ff201d6c74600000000000000000000000086e3142d34baf155b618eb1387b4b781aa88fccd00000000000000000000000091b05f8493656d362751c83547ba4cc28907ba59000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000007d00000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000003e80000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000041fce2e361a8c65892804cb43f30041ac20271cc4dcdbd5df351340bad55c6f2610a4ff5b8e7136e6f613045ed0b1bd77349d3435a9eb1d80221b141801c7bee971b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ad57419089a9ddd5e92622ee94958b5d8bf08bbf30737e216686dfc596bf5d1f48f16433d7358e1fe3d7dd8cdf554ea3991be5e5f9c59482ca3fc5aaa2a1bc0b1b00000000000000000000000000000000000000000000000000000000000000"
)

var (
	globalConfig config.Config = config.Config{
		ConnnectionString: "postgres://postgres:postgres@localhost:5432/relayer?sslmode=disable",
	}
	sepoliaEthClient *ethclient.Client
	bnbEthClient     *ethclient.Client
	evmPrivateKey    string
	evmUserPrivKey   string
	evmUserAddress   string
	sepoliaConfig    *evm.EvmNetworkConfig = &evm.EvmNetworkConfig{
		ChainID: 11155111,
		ID:      CHAIN_ID_SEPOLIA,
		Name:    "Ethereum sepolia",
		RPCUrl:  "wss://eth-sepolia.g.alchemy.com/v2/nNbspp-yjKP9GtAcdKi8xcLnBTptR2Zx",
		//Gateway:    "0x842C080EE1399addb76830CFe21D41e47aaaf57e",
		Gateway:    "0xD8DE1B2e8EcC56Ed32CdcAcD088a28490BCA367C",
		PrivateKey: "",
		Finality:   1,
		BlockTime:  time.Second * 12,
		LastBlock:  7458561,
		GasLimit:   300000,
	}
	bnbConfig *evm.EvmNetworkConfig = &evm.EvmNetworkConfig{
		ChainID:    97,
		ID:         CHAIN_ID_BNB,
		Name:       "Ethereum bnb",
		RPCUrl:     "wss://bnb-testnet.g.alchemy.com/v2/DpCscOiv_evEPscGYARI3cOVeJ59CRo8",
		Gateway:    "0x8cFc0173f7D1701bf5010B15B9762264d88c4235",
		PrivateKey: "",
		Finality:   1,
		BlockTime:  time.Second * 12,
		LastBlock:  47254017,
		GasLimit:   300000,
	}
	bnbClient     *evm.EvmClient
	sepoliaClient *evm.EvmClient
)

func TestMain(m *testing.M) {
	// Load .env file
	err := godotenv.Load("../../../.env.test")
	if err != nil {
		log.Error().Err(err).Msg("Error loading .env.test file: %v")
	}
	evmPrivateKey = os.Getenv("EVM_PRIVATE_KEY")
	evmUserPrivKey = os.Getenv("EVM_USER_PRIVATE_KEY")
	evmUserAddress = os.Getenv("EVM_USER_ADDRESS")
	bnbConfig.RPCUrl = os.Getenv("URL_BNB_WSS")
	sepoliaConfig.PrivateKey = evmPrivateKey
	bnbConfig.PrivateKey = evmPrivateKey
	sepoliaEthClient, _ = createEVMClient("RPC_SEPOLIA")
	bnbEthClient, _ = createEVMClient("RPC_BNB")

	log.Info().Msgf("Creating evm client with config: %v", sepoliaConfig)
	dbAdapter, _ := createDbAdapter()
	sepoliaClient, err = evm.NewEvmClient(&globalConfig, sepoliaConfig, dbAdapter, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	bnbClient, err = evm.NewEvmClient(&globalConfig, bnbConfig, dbAdapter, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	os.Exit(m.Run())
}
func createDbAdapter() (*db.DatabaseAdapter, error) {
	dbAdapter, err := db.NewDatabaseAdapter(&globalConfig)
	if err != nil {
		log.Error().Msgf("failed to create db adapter: %v", err)
	}
	return dbAdapter, nil
}
func createEVMClient(key string) (*ethclient.Client, error) {
	rpcEndpoint := os.Getenv(key)
	rpcSepolia, err := rpc.DialContext(context.Background(), rpcEndpoint)
	if err != nil {
		fmt.Printf("failed to connect to sepolia with rpc %s: %v", rpcEndpoint, err)
		return nil, err
	}
	return ethclient.NewClient(rpcSepolia), nil
}

func TestSepoliaRecoverEvents(t *testing.T) {
	sepoliaClient, err := evm.NewEvmClient(&globalConfig, sepoliaConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	//Log missing logs
	go func() {
		scalarGatewayAbi, _ := contracts.IScalarGatewayMetaData.GetAbi()
		events := map[string]abi.Event{}
		for _, event := range scalarGatewayAbi.Events {
			events[event.ID.String()] = event
		}
		for !sepoliaClient.MissingLogs.IsRecovered() {
			logs := sepoliaClient.MissingLogs.GetLogs(10)
			for _, txLog := range logs {
				topic := txLog.Topics[0].String()
				event, ok := events[topic]
				if !ok {
					log.Error().Str("topic", topic).Any("txLog", txLog).Msg("[EvmClient] [ProcessMissingLogs] event not found")
					continue
				}
				log.Debug().
					Str("chainId", sepoliaClient.EvmConfig.GetId()).
					Str("eventName", event.Name).
					Str("txHash", txLog.TxHash.String()).
					Msg("[EvmClient] [ProcessMissingLogs] processing missing event")
			}
		}
		log.Info().Str("Chain", sepoliaClient.EvmConfig.ID).Msg("[EvmClient] [ProcessMissingLogs] finished processing all missing evm events")

	}()
	err = sepoliaClient.RecoverAllEvents(context.Background())
	require.NoError(t, err)
	select {}
}

func TestBnbRecoverEvents(t *testing.T) {
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	err = bnbClient.RecoverAllEvents(context.Background())
	require.NoError(t, err)
}

func TestEvmClientListenContractCallEvent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayContractCall)

	subContractCall, err := sepoliaClient.Gateway.WatchContractCall(&watchOpts, sink, nil, nil)
	if err != nil {
		log.Error().Err(err).Msg("ContractCallEvent")
	}
	if subContractCall != nil {
		log.Info().Msg("Subscribed to ContractCallEvent successfully.")
		go func() {
			log.Info().Msg("Waiting for events...")
			for event := range sink {
				log.Info().Any("event", event).Msgf("ContractCall")
			}
		}()
		go func() {
			errChan := subContractCall.Err()
			if err := <-errChan; err != nil {
				log.Error().Err(err).Msg("Received error")
			}
		}()
	}
	select {}
}

func TestEvmClientListenContractCallApprovedEvent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayContractCallApproved)

	subContractCallApproved, err := sepoliaClient.Gateway.WatchContractCallApproved(&watchOpts, sink, nil, nil, nil)
	if err != nil {
		log.Error().Err(err).Msg("ContractCallApprovedEvent")
	}
	if subContractCallApproved != nil {
		log.Info().Msg("Subscribed to ContractCallApprovedEvent successfully.")
		go func() {
			log.Info().Msg("Waiting for events...")
			for event := range sink {
				log.Info().Any("event", event).Msgf("ContractCallApproved")
			}
		}()
		go func() {
			errChan := subContractCallApproved.Err()
			if err := <-errChan; err != nil {
				log.Error().Err(err).Msg("Received error")
			}
			subContractCallApproved.Unsubscribe()
		}()
	}
	select {}
}
func TestEvmClientListenEVMExecutedEvent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayExecuted)

	subExecuted, err := sepoliaClient.Gateway.WatchExecuted(&watchOpts, sink, nil)
	if err != nil {
		log.Error().Err(err).Msg("ExecutedEvent")
	}
	if subExecuted != nil {
		log.Info().Msg("Subscribed to ExecutedEvent successfully. Waiting for events...")
		go func() {
			for event := range sink {
				log.Info().Any("event", event).Msgf("Executed")
			}
		}()
		go func() {
			errChan := subExecuted.Err()
			if err := <-errChan; err != nil {
				log.Error().Err(err).Msg("Received error")
			}
		}()
	}
	select {}
}
func TestRecoverEvent(t *testing.T) {
	fnCreateEventData := func(log types.Log) *contracts.IScalarGatewayContractCall {
		return &contracts.IScalarGatewayContractCall{
			Raw: log,
		}
	}
	err := evm.RecoverEvent[*contracts.IScalarGatewayContractCall](sepoliaClient, context.Background(), events.EVENT_EVM_CONTRACT_CALL, fnCreateEventData)
	require.NoError(t, err)
}
func TestEvmSubscribe(t *testing.T) {
	fmt.Println("Test evm client")

	// Connect to Ethereum client
	client, err := ethclient.Dial(sepoliaConfig.RPCUrl)
	require.NoError(t, err)
	if err != nil {
		fmt.Printf("failed to connect to the Ethereum client: %v", err)
	}

	// Get current block
	currentBlock, err := client.BlockNumber(context.Background())
	require.NoError(t, err)
	if err != nil {
		fmt.Printf("failed to get current block: %v", err)
	}
	fmt.Printf("Current block %d\n", currentBlock)

	// Create the event signature
	contractCallSig := []byte("ContractCall(address,string,string,bytes32,bytes)")

	// Create the filter query
	query := ethereum.FilterQuery{
		Addresses: []common.Address{common.HexToAddress(sepoliaConfig.Gateway)},
		Topics: [][]common.Hash{{
			crypto.Keccak256Hash(contractCallSig),
		}},
	}

	// Subscribe to events
	logs := make(chan types.Log)
	sub, err := client.SubscribeFilterLogs(context.Background(), query, logs)
	require.NoError(t, err)
	if err != nil {
		fmt.Printf("failed to subscribe to logs: %v", err)
	}

	// Handle events in a separate goroutine
	go func() {
		for {
			select {
			case err := <-sub.Err():
				fmt.Printf("Received error: %v", err)
			case vLog := <-logs:
				fmt.Println("Log:", vLog)
			}
		}
	}()

	// Keep the program running
	select {}
}
func TestRecoverEventTokenSent(t *testing.T) {
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	require.NoError(t, err)
	//Get current block number
	blockNumber, err := bnbClient.Client.BlockNumber(context.Background())
	require.NoError(t, err)
	lastCheckpoint := scalarnet.EventCheckPoint{
		ChainName:   bnbConfig.ID,
		EventName:   events.EVENT_EVM_TOKEN_SENT,
		BlockNumber: blockNumber - 10000,
		TxHash:      "",
		LogIndex:    0,
		EventKey:    "",
	}
	missingEvents, err := evm.GetMissingEvents[*contracts.IScalarGatewayTokenSent](bnbClient, events.EVENT_EVM_TOKEN_SENT,
		&lastCheckpoint, func(log types.Log) *contracts.IScalarGatewayTokenSent {
			return &contracts.IScalarGatewayTokenSent{
				Raw: log,
			}
		})
	require.NoError(t, err)
	fmt.Printf("missingEvents %v\n", missingEvents)
}
func TestRecoverEventContractCallWithToken(t *testing.T) {
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	require.NoError(t, err)
	//Get current block number
	blockNumber, err := bnbClient.Client.BlockNumber(context.Background())
	fmt.Printf("blockNumber %v\n", blockNumber)
	require.NoError(t, err)
	lastCheckpoint := scalarnet.EventCheckPoint{
		ChainName:   bnbConfig.ID,
		EventName:   events.EVENT_EVM_CONTRACT_CALL_WITH_TOKEN,
		BlockNumber: bnbConfig.LastBlock,
		TxHash:      "",
		LogIndex:    0,
		EventKey:    "",
	}
	missingEvents, err := evm.GetMissingEvents[*contracts.IScalarGatewayContractCallWithToken](bnbClient, events.EVENT_EVM_CONTRACT_CALL_WITH_TOKEN,
		&lastCheckpoint, func(log types.Log) *contracts.IScalarGatewayContractCallWithToken {
			return &contracts.IScalarGatewayContractCallWithToken{
				Raw: log,
			}
		})
	require.NoError(t, err)
	fmt.Printf("%d missing events found\n", len(missingEvents))

	txHash := "0xc7d4fac102169c129a4f04ccd4e3fa17fcd962f137e4928fb2462c52da039899"
	tx, isPending, err := bnbClient.Client.TransactionByHash(context.Background(), common.HexToHash(txHash))
	fmt.Printf("tx %v\n", tx)
	fmt.Printf("isPending %v\n", isPending)
	fmt.Printf("err %v\n", err)
	txHash = "1c9623e21b55e9c4767a12b27f9f68578c167284651efb2b87a51ce438e9fa53"
	tx, isPending, err = bnbClient.Client.TransactionByHash(context.Background(), common.HexToHash(txHash))
	require.NoError(t, err)
	fmt.Printf("tx %v\n", tx)
	fmt.Printf("isPending %v\n", isPending)
	fmt.Printf("err %v\n", err)

	log.Info().Str("txHash", txHash).Any("tx", tx).Msgf("ContractCallWithToken")
	for _, event := range missingEvents {
		receipt, err := bnbClient.Client.TransactionReceipt(context.Background(), common.HexToHash(event.Hash))
		require.NoError(t, err)
		log.Info().Str("txHash", event.Hash).Any("receipt", receipt).Msgf("ContractCallWithToken")
	}
}

func TestEvmClientWatchTokenSent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayTokenSent)
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	subscription, err := bnbClient.Gateway.WatchTokenSent(&watchOpts, sink, nil)
	require.NoError(t, err)
	defer subscription.Unsubscribe()
	log.Info().Msgf("[EvmClient] [watchEVMTokenSent] success. Listening to TokenSent")

	for {
		select {
		case err := <-subscription.Err():
			log.Error().Msgf("[EvmClient] [watchEVMTokenSent] error: %v", err)
		case event := <-sink:
			log.Info().Any("event", event).Msgf("EvmClient] [watchEVMTokenSent]")
		}
	}
}
func TestSendTokenFromSepoliaToBnb(t *testing.T) {
	fmt.Println("Test SendToken From Sepolia to BnB")
	fmt.Printf("DestChain %s, TokenSymbol %s, UserAddress %s", CHAIN_ID_BNB, TOKEN_SYMBOL, evmUserAddress)
	sepoliaGwAddr := "0x842C080EE1399addb76830CFe21D41e47aaaf57e"
	amount := big.NewInt(10000)

	sepoliaGateway, _, err := evm.CreateGateway("Sepolia", sepoliaGwAddr, sepoliaEthClient)
	assert.NoError(t, err)
	sepoliaConfig.PrivateKey = evmUserPrivKey
	fmt.Printf("SepoliaConfig %v\n", sepoliaConfig)
	transOpts, err := evm.CreateTransactOpts(sepoliaConfig)
	assert.NoError(t, err)
	//Need to incrate allowance if need
	// tokenAddress := "0x6e3B806C5F6413e0a0670666301ccB6b10628A52"
	// proxy, err := createErc20ProxyContract(tokenAddress, sepoliaClient)
	// assert.NoError(t, err)
	// allowance, err := proxy.Allowance(callOpts, common.HexToAddress(evmUserAddress), common.HexToAddress(sepoliaGwAddr))
	// assert.NoError(t, err)
	// if allowance.Int64() < amount.Int64() {
	// 	proxy.IncreaseAllowance(transOpts, common.HexToAddress(sepoliaGwAddr), amount)
	// }
	time.Sleep(15 * time.Second)
	tx, err := sepoliaGateway.SendToken(transOpts, CHAIN_ID_BNB, evmUserAddress, TOKEN_SYMBOL, amount)
	assert.NoError(t, err)
	fmt.Printf("SendToken tx %v\n", tx)
}
func TestReconnectWithWatchTokenSent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayTokenSent)
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	subscription, err := bnbClient.Gateway.WatchTokenSent(&watchOpts, sink, nil)
	require.NoError(t, err)
	defer subscription.Unsubscribe()
	log.Info().Msgf("[EvmClient] [watchEVMTokenSent] success. Listening to TokenSent")
	done := false
	for !done {
		select {
		case err := <-subscription.Err():
			log.Error().Err(err).Msg("[EvmClient] [watchEVMTokenSent] error with subscription, perform reconnect")
			subscription, err = bnbClient.Gateway.WatchTokenSent(&watchOpts, sink, nil)
			require.NoError(t, err)
		case <-watchOpts.Context.Done():
			log.Info().Msgf("[EvmClient] [watchEVMTokenSent] context done")
			done = true
		case event := <-sink:
			log.Info().Any("event", event).Msgf("EvmClient] [watchEVMTokenSent]")
		}
	}
}
func createErc20ProxyContract(proxyAddress string, client *ethclient.Client) (*contracts.IScalarERC20CrossChain, error) {
	proxy, err := contracts.NewIScalarERC20CrossChain(common.HexToAddress(proxyAddress), client)
	if err != nil {
		return nil, fmt.Errorf("failed to initialize proxy contract from address: %s", proxyAddress)
	}
	return proxy, nil
}
