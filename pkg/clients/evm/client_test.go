package evm_test

import (
	"context"
	"encoding/hex"
	"fmt"
	"math/big"
	"os"
	"strings"
	"testing"
	"time"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/ethereum/go-ethereum/rpc"
	"github.com/joho/godotenv"
	"github.com/rs/zerolog/log"
	"github.com/scalarorg/data-models/scalarnet"
	"github.com/scalarorg/relayers/config"
	"github.com/scalarorg/relayers/pkg/clients/evm"
	contracts "github.com/scalarorg/relayers/pkg/clients/evm/contracts/generated"
	"github.com/scalarorg/relayers/pkg/db"
	"github.com/scalarorg/relayers/pkg/events"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

const (
	CHAIN_ID_SEPOLIA = "evm|11155111"
	CHAIN_ID_BNB     = "evm|97"
	TOKEN_SYMBOL     = "pBtc"
	PAYLOAD          = "09c5eabe00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000032c000000000000000000000000000000000000000000000000000000000000032600000000000000000000000000000000000000000000000000000000000aa36a70000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000012c0000000000000000000000000000000000000000000000000000000000000002455bef350f2157a165b0100e050736f2fa3c9fad3f92cc0eb3b6c991b79bd8e0b58f93abc701d55f690c01ee1403736a6a14b7284aeeacccb8e22ba92f39cce0a601d745ae6426c8335aca5eae6aca667b4daafb96384abb0afe948afb5c2c95e7b899ba83c82e44b54c6d83712f34b401156c3689ac2d0bacf8652c7aa35fc399885215899053d80f23ece648442e03b3f5f606440f067173636649e5e88b4acd178757d0325bc694f211d27d0be26b4a393b1c96595ef7ee32b02ac85c4730609759cc6e2936fa9b61c14ec050a2817e2c1173d79f7d9980d5d029d9d5a668548fcb3a2b2ba272d34775ad397bdfe42ea6123746fec3758071eb2297fb9911a4b6316f58a3b8abcee4689047103fac27be52b46bcdead5ffdfa15ead599026e50a24f30928222fbdd72b80bccfda6ac3d4b55838f7419f9b5053eb370b2d039534fc9d89156cf73b842aa1c43fb8b88a73682584fb7d9d24b9a9d1f1ceb9961570e9aaea97385d776c915891cc4b19f7ae457aeeca74a6a30eb383962d3b97d6d5c9f687f908d763bf90b0e3532a3eeeb16d303169ca3e0dd6959c2d81aa1c498a3cfcbd6984dc2c862be6ce8efe0f2638055f891b9d68833b1251f7aa9109dac7aa26020468029874e5ef53d20cd828cab890835671c2586bb92a005a7f1b2b5a7101e42fcdd3f93474e27d526d86b4e9829cf1251524394b8418523609722b74e656984036aacc9e39923d1e63e9e77d2b568b14f2091e17ea8804074dd62bb93bfb49c40eac30cf8be615fb9edf8cefc03a28de753add6f4101d70e8ef4fd98f981b24e7189f20a46ee780b9395a3997b65de36bf050820b11cf2d23c591d9e55658cb3794be9766b000c2c3855061090522405e10430cb548c3a8ade204dbc102302e9f3584f23b5a47c8335718f99910c11d688d08d080eba5164e9510e4626c4489470391384bb79b5e5b8f4b0decf65d441fd8b3251163ed1e7a9926eea10adbf2264f8b1119d5c294326af55d40f3356206ae4af7d8359752e57a9ef08de22b1020bff455a3760e4391bc304c51ae9451571a45af186aa973385d88f5754291e5fd0fa0de8cf0ed4a97e41d8e7c692966ff593f08275c292adfe4550cd661fcf3582508f258e09c20f96bde6c14801027a2656a40ca0a7baeeba9f32283efc30958556e279202a1f0a0b822f1b8b994d3ee16a17d9650f4b0f126d630823aec6d06ed2ae39f5d2001b73e16a9457c70754555cdded55de6d517f7b048da83f624c4f822f652c83e6137fad6656c5b61a010379b1f027ff768943df953331b9baa93fb398136a7b932e717a2f4a773f44b884c10290e41098abb4bf2737b96f001e26a44d6009a262c0f02cf717a381a9cb271b160206d8612e11aab77e97f9c2318d849eead449840ba300da4392ade482b8ad0c67d2f78ffd8549a865fb2efc47857d8237fdb74ce383a2228b0623b6c9309fe7e2f0d9b316621ef8e6a40f1e5779ca58380bc851e98a4c3c1675e407c08c9dace2f10e8f630ff97bfe7f5285946cf9a26ed5a6b6b7d2c441f5e341893e0220d78293cd608a1b8d4caae04c8f0b0fc4766ba72aea07e005904051b580551f6327d0e4ec6a19213e40000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000048000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000006c000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000740000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000007c000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000008c000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000000000000000000000000098000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000bc00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000d4000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000006c000000000000000000000000000000000000000000000000000000000000007800000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d800000000000000000000000000000000000000000000000000000000000000e400000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000fc000000000000000000000000000000000000000000000000000000000000010800000000000000000000000000000000000000000000000000000000000001140000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000012c000000000000000000000000000000000000000000000000000000000000013800000000000000000000000000000000000000000000000000000000000001440000000000000000000000000000000000000000000000000000000000000150000000000000000000000000000000000000000000000000000000000000015c000000000000000000000000000000000000000000000000000000000000016800000000000000000000000000000000000000000000000000000000000001740000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000018c000000000000000000000000000000000000000000000000000000000000019800000000000000000000000000000000000000000000000000000000000001a400000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000001bc00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000001d400000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000001ec000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a64521e0498d452065bce60dfe4f0ca3361227e00000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000df0aefe0cc8d54c9f3f63a6d40eda1e79987ba7e00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000e3ad978ef26858bdf46ad3f35860f25729f3490200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000e62870f158eda4553114a9a8c483c0b49e7a6b8100000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000710c55e17cd496be73ff864ff6b9de44d848ab3000000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a36c2c793259092beb19189b9ddff47b8fe5a46300000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a32df615f632bf5ebbf36c182db7e438aa9cd1a00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007434e0df36a707c7f94aa55917962448e1cec7d800000000000000000000000000000000000000000000000000000000000023280000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa0000000000000000000000000000000000000000000000000000000000000d9a0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fcd58512bd3e465a19f99a9c072b3ad6117395d200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b0000000000000000000000000000000000000000000000000000000000001b340000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a32df615f632bf5ebbf36c182db7e438aa9cd1a00000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000582dd2d558a1a0626f47b5b50a44d403359d61a300000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fcd58512bd3e465a19f99a9c072b3ad6117395d200000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000456b707a24bf46ef6d4582d07cffd45340718aaf00000000000000000000000000000000000000000000000000000000000007d00000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b62bc77dc17290c709fa88e491ddc3321a6a2ed400000000000000000000000000000000000000000000000000000000000014670000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004fab6cb4c6e8b72f1529eda3e71f45127a85d4440000000000000000000000000000000000000000000000000000000000002f9b0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d0000000000000000000000000000000000000000000000000000000000000d9a0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000582dd2d558a1a0626f47b5b50a44d403359d61a300000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004fab6cb4c6e8b72f1529eda3e71f45127a85d4440000000000000000000000000000000000000000000000000000000000000d9a0000000000000000000000000000000000000000000000000000000000000004744274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b62bc77dc17290c709fa88e491ddc3321a6a2ed40000000000000000000000000000000000000000000000000000000000000d9a00000000000000000000000000000000000000000000000000000000000000047442746300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000177000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000040000000000000000000000001ad5e55e61ac27b9f9e2f2517892871b12692e760000000000000000000000003114bec56527c45d782ebfa715d26ff201d6c74600000000000000000000000086e3142d34baf155b618eb1387b4b781aa88fccd00000000000000000000000091b05f8493656d362751c83547ba4cc28907ba59000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000007d00000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000003e80000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000041fce2e361a8c65892804cb43f30041ac20271cc4dcdbd5df351340bad55c6f2610a4ff5b8e7136e6f613045ed0b1bd77349d3435a9eb1d80221b141801c7bee971b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ad57419089a9ddd5e92622ee94958b5d8bf08bbf30737e216686dfc596bf5d1f48f16433d7358e1fe3d7dd8cdf554ea3991be5e5f9c59482ca3fc5aaa2a1bc0b1b00000000000000000000000000000000000000000000000000000000000000"
	BIG_EXECUTE_DATA = "0x224c9778000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000049400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000045a00000000000000000000000000000000000000000000000000000000000aa36a7000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000019c000000000000000000000000000000000000000000000000000000000000000320bb388eb21a349905ec4149500f0285aad6fd0abc4748bb5c932eca1e931bf220dba2c5d48a4d04abde76572f1a41386c2dc3ff1d5526ada45e5195908fd96251de75262839826d32ef882b8199dd462129aa74974957e57dfbdf4c532bea5094105b579e7fc1f89425822d28befb64be319d79f1767ac1ff46305d0e091d81b4eca1a8bd6d479c5bb0b06e847c304fc0a1836ec7a58f670f5470b9505168517564948a9bb55d7662039c2650c54fcce9f5295540f19a05000e2e791fc1d3c2a648b7c18576146320327c4dd09a8adc19ad782f5db10259a8b62a9834a9b8b128bac55022e1b58da39a175acc77de056c1ba4975b5a5a777e16c826946d7040cb5a3130cd8b0ecd86940e160fe33a28af32806c0930339d5b5d09527c12a922bd0601316c98bbd9b3c1c88d821f7baf6c9d1e0745c28ce23e1682bb6aede4a230eede4c7e847a4b7b0aebf697b72f04e8c1284e44ad91a58b9ff33304df1d8081da0b63b6ff8f78723084b950be3842547009cb498f0caceda8a145724576995224598e880a71eed260e39ff04a0a409289872ebb07e10bb70b6a33e29532c052c8396963d89f1d16facbaed35cccc75d36b147ddca9dc42c37a0a71e4636f992e20805f5c0cc5b5720d5541584c6200afeda5c1a487e7b9ae92f025f3a53a00455b99b911a1dfeb93b2cace79e624120c421e92b3357f08bad5012c696921065f1fd020923d8f44b6cc4547e84e0273c1dbd6c5c65fd89c5f09d6d62138d0fc6e041e3e2646155ecd344812f7c5f83d58df18cb28073a4f7d82fa8a7ece1607b744722d6c20cd2b0f9cd667f2c808925934c05805563030629aec5e0c2e3f23006681af1860770e95083795754a67e17df863a72f22fc8716b0fa9934a4e43302d5b653594c03cbc2a1491d172680dd39bb46eb07f8926e377319c649aca1a305a5b6e93959044783dd14812bfcb2dc9eb1889afec62d315b7a0b4d61c9ae9e07716f570e40d11cb81bfad550fe00fc7dfb6f3be5b86ebe6baa617c19e84acf08082505fbe06a3bd085e889853dc68216da670848eedfd8ca4ef904f4bb38cc0d85520e1da94961dfb381176914990af9dae661e25783ac527068c2f37d0fa50db686805b3b7312e9254f31ba46b0636ef47c5dc2b0cf2cd693ba58452824a012313ff0d498071b955442d2109140940caacded2e8f1f7f64f7e5bf4f9cfd8a14080760e95420904226933393e70ca113e09ee3378f4834c3d51194f01b117714efdb0fadc704a90d1d2447b8f7604329927fc672339e38d5c469bbf4ea0c441a14811a706af78f1cdc731804d7f7bc8dea5830aecd93068a8517aaeb6caea31f0c45394cf92b6a43240787ce06cdedd98d6c8933d5cdcd047e4b9edae6cef320b929ed86072e2195ca9c8fbc1d2d241146d09c488220e85d7656f1b2d64dc423d50eef0606907ee3dcab80367af0d2485bb8fda66fa723d6d6010decb275ac24e2782a91d9d3c5cdc3fb8cb041bfa646719edd717c5ef2c104a8d20597a83226a694ebd3dcec1a8a23abf9611bd1dc7eae4d5bdfbb6ed92d97be8c2374c3b927da86c5ab6726305f36fefe2b61c660dce86866f40af5807dda68be09939bce2ea5cc02e596999ebec3a78ded144745b4b3c08c1ba75e2d04f9823ebf887ce13595dcd4d1bf2c74aadc9e4bfba5e1fde965fc810d772b9ae09f1d91c30e2e703724a06aa1c9c2c5256630acfebd1ed3b6d2da0053545eb45b01327dfa67c83640285684c3febddfb6f94c111cc3da5d94c02f5da0a520ebbf8f9b105a10acd5414703d39f92d97e461eb95ee455f32cf6f4e2cb7033d894e9f553c069c4a82b43d2b54eeaa780616e28cec23fa175282ca05529d89fefae55ca6afd698be07244dd4692278afea899cce28bd333062138d92782c1a30022a7d446546f7baac944e3127cc718b518e2e1c13b2e89f2de3d91aa3aa16ed27b3d4f436191bd873144ff8df572207d4de8d73691553ce9bbb84cde90cc0f997b075ae982261a4cd34a83b7d4574747731af9d406751a0d19e23ff91f8ad238db79ae1e484d9602ef521d3824354b2dbe972471ea1aadb32bfa468d76c8652f9e9c4efd227eb290e65484444ed75f925dd6cd63e1270f9a6f90948beedfd21ad491754a71b76638b2596c9dba366e2e9584e98e8a53d871699164654d938791a92713e4c99956049959aca882dc49738b711ec709153c7288d62c97df67b98ebf7e224421d31ae94d00000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000006c000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000740000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000007c000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000008c000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000000000000000000000000098000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000bc00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000c800000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000d400000000000000000000000000000000000000000000000000000000000000d800000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000e400000000000000000000000000000000000000000000000000000000000000e800000000000000000000000000000000000000000000000000000000000000ec00000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000f400000000000000000000000000000000000000000000000000000000000000f800000000000000000000000000000000000000000000000000000000000000fc000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000108000000000000000000000000000000000000000000000000000000000000010c000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000001140000000000000000000000000000000000000000000000000000000000000118000000000000000000000000000000000000000000000000000000000000011c000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001240000000000000000000000000000000000000000000000000000000000000128000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096d696e74546f6b656e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000007c0000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000e800000000000000000000000000000000000000000000000000000000000000f40000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010c000000000000000000000000000000000000000000000000000000000000011800000000000000000000000000000000000000000000000000000000000001240000000000000000000000000000000000000000000000000000000000000130000000000000000000000000000000000000000000000000000000000000013c000000000000000000000000000000000000000000000000000000000000014800000000000000000000000000000000000000000000000000000000000001540000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000016c000000000000000000000000000000000000000000000000000000000000017800000000000000000000000000000000000000000000000000000000000001840000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000019c00000000000000000000000000000000000000000000000000000000000001a800000000000000000000000000000000000000000000000000000000000001b400000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000001cc00000000000000000000000000000000000000000000000000000000000001d800000000000000000000000000000000000000000000000000000000000001e400000000000000000000000000000000000000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000001fc000000000000000000000000000000000000000000000000000000000000020800000000000000000000000000000000000000000000000000000000000002140000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000022c000000000000000000000000000000000000000000000000000000000000023800000000000000000000000000000000000000000000000000000000000002440000000000000000000000000000000000000000000000000000000000000250000000000000000000000000000000000000000000000000000000000000025c000000000000000000000000000000000000000000000000000000000000026800000000000000000000000000000000000000000000000000000000000002740000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000028c000000000000000000000000000000000000000000000000000000000000029800000000000000000000000000000000000000000000000000000000000002a400000000000000000000000000000000000000000000000000000000000002b0000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000438b5dc78e40beadf5f544cd9f3101567b0214af00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000524b8c4a1bc63ab21a0412c7c6093631e88bd9100000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000066532b830ad2711269b9c643a630baaf0a0d06f200000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000008bdb827f75ba684b232319d81b02ecf6cb212d9300000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000617a76a4ebc6c711824a130fbb8970a635aef82600000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000082f37844ad466f10febc1a3cc33cfa52f4f0f95c00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000062d832f807f2272b19fb5b114032cb49e03cec2800000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000582dd2d558a1a0626f47b5b50a44d403359d61a300000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001f3b5b03366dd348421c5e29477884fcca9fcd3200000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000008f1d0b8a5edb8f6627b78636afb41ecb69d9a12d00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000057506f4d92e6b090350bbac30f469baaa0b34b3f00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000cd77f1f0eb0f5477dc5f5d6e6a7200df94e4f1200000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000c6d489c1f240058af36e566a86b9c256bd26cfa00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cd819e500b6ad227d08151e0b56768f7a12bd82b00000000000000000000000000000000000000000000000000000000000006cd0000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000005b57251dbee96d3288b6108890fb81ca36e1b9c400000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000e5860700a9c57f97bcab237961fd474dce718b4600000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004fab6cb4c6e8b72f1529eda3e71f45127a85d44400000000000000000000000000000000000000000000000000000000000019520000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000438c54198ce41b757efc52ee24f4d8a3a03c921c00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000f68b637ff3ba4217d7c45566c5134622e16a7b9c00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000007a32df615f632bf5ebbf36c182db7e438aa9cd1a00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000256d93ab9d4af5c67b1aef990352c752ba4ba77400000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c7c4f0cddbbaed113b0a16dd5c256a272e93153600000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b0ba9e0a04151b5720d306c741dd5f1ca2a42e9100000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000556f8d5c47dd06bf2b02bda439529cd3b605ed7e00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000f3e6acc9126ba9b301cad653ddc9c70d63761a00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000524e3631d933221bb36d3aeb17174640b988f60800000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000006faeb14aac7110d2257b80d06ce8f6bd0436fd4c00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000070c87db7c3f752f552d0309acdb4659d4e45f26900000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000001695b73172470288dc9de47b79877a2902807fdc00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fe0fa447213fabd57f91346af88bedb612bb135d00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c36566a3ed16cf0fb5e9843ad37e9659685a065d00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002512d94ca3018c5ac2860e72651de78f6ab6dcb700000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000005ca3a5f3dc4a294f42cbeb892bb72a7e88901fd600000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000006ad442e7e1219147d0ac90f689c98541d8b5f03e00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fcd58512bd3e465a19f99a9c072b3ad6117395d200000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c4f35bafe94fff8bd385691bdc3352c04e2a176000000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a81df06e1edfd9f312bb22fa24011af2e4ed50ed00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000093546a42d06a7e10c32552059724e669f292679d00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000076e207749251512f54bc8c97f9f5b95fb5c450b800000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000b05319cd0e627ec17d8b0400570ac24186ef351100000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000d6193b21987d67c37faf225ce4cfcfe8fdd79d400000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000006205cb271673c488b76c1fb83291f0a9be7daf6400000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000022c9c6da49ec059cd2e1dc437b722045a5684a6e00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000ed1bd418f9427973e74ce2ef0f23e6e21e3c780d00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000009cfe21e6a07c17e6145cbbff0c1f59b3be40821c00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000057827e28b122827f01cbfab66bb27e4ad61a681d00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000fc12ff3e57692cf17ab79075ced4bafe6523c51e00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000006000000000000000000000000080535d38ec581cb13c9947df4299967a16b2be8300000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002948a5d80035b9d476ed7c24b3ca19f5ffde78ad00000000000000000000000000000000000000000000000000000000000012850000000000000000000000000000000000000000000000000000000000000004734274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004fab6cb4c6e8b72f1529eda3e71f45127a85d444000000000000000000000000000000000000000000000000000000000000128500000000000000000000000000000000000000000000000000000000000000047342746300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000177000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000400000000000000000000000007107e9349b2126ab0783b772432082629501e720000000000000000000000007175715c10086c15fdac0b7ac8d4fb6956cc081a0000000000000000000000007dce1d12ee4f8932a099d3aab12f2ef1bfacb5aa00000000000000000000000087e34db76fb9a3ab0ae69d1ee82ce07840b9224f00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000000000000000000000000000000000000000007d00000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000003e80000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000041f3b5315f0a3c3610f2b434610e6198e50b9c2a6db5dfcbc1a669c6071e6fd757750a3e1f27b5ee03b6470279afad882aae38da40926b23de402696682471979d1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000416fd0177fc8673ef5c3e838fd67a4dfa42415700ecf8db51bd9ce34d6e7f6c5830f04d196c51341955e2ad03ea77af47486f6096455378e93007d1c5f5d697cc91b00000000000000000000000000000000000000000000000000000000000000"
)

var (
	globalConfig config.Config = config.Config{
		ConnnectionString: "postgres://postgres:postgres@localhost:5432/relayer?sslmode=disable",
	}
	sepoliaEthClient *ethclient.Client
	bnbEthClient     *ethclient.Client
	evmPrivateKey    string
	evmUserPrivKey   string
	evmUserAddress   string
	sepoliaConfig    *evm.EvmNetworkConfig = &evm.EvmNetworkConfig{
		ChainID: 11155111,
		ID:      CHAIN_ID_SEPOLIA,
		Name:    "Ethereum sepolia",
		RPCUrl:  "wss://eth-sepolia.g.alchemy.com/v2/nNbspp-yjKP9GtAcdKi8xcLnBTptR2Zx",
		//Gateway:    "0x842C080EE1399addb76830CFe21D41e47aaaf57e",
		Gateway:    "0x78eE3111ab44078FB32D7E7A7bCf99cf3664415B", //Version Mar 27, 2025
		PrivateKey: "",
		Finality:   1,
		BlockTime:  time.Second * 12,
		LastBlock:  7458561,
		GasLimit:   300000,
	}
	bnbConfig *evm.EvmNetworkConfig = &evm.EvmNetworkConfig{
		ChainID:    97,
		ID:         CHAIN_ID_BNB,
		Name:       "Ethereum bnb",
		RPCUrl:     "wss://bnb-testnet.g.alchemy.com/v2/DpCscOiv_evEPscGYARI3cOVeJ59CRo8",
		Gateway:    "0x8cFc0173f7D1701bf5010B15B9762264d88c4235",
		PrivateKey: "",
		Finality:   1,
		BlockTime:  time.Second * 12,
		LastBlock:  47254017,
		GasLimit:   300000,
	}
	bnbClient     *evm.EvmClient
	sepoliaClient *evm.EvmClient
)

func TestMain(m *testing.M) {
	// Load .env file
	err := godotenv.Load("../../../.env.test")
	if err != nil {
		log.Error().Err(err).Msg("Error loading .env.test file: %v")
	}
	evmPrivateKey = os.Getenv("EVM_PRIVATE_KEY")
	evmUserPrivKey = os.Getenv("EVM_USER_PRIVATE_KEY")
	evmUserAddress = os.Getenv("EVM_USER_ADDRESS")
	bnbConfig.RPCUrl = os.Getenv("URL_BNB_WSS")
	sepoliaConfig.PrivateKey = evmPrivateKey
	bnbConfig.PrivateKey = evmPrivateKey
	sepoliaEthClient, _ = createEVMClient("RPC_SEPOLIA")
	bnbEthClient, _ = createEVMClient("RPC_BNB")

	log.Info().Msgf("Creating evm client with config: %v", sepoliaConfig)
	dbAdapter, _ := createDbAdapter()
	sepoliaClient, err = evm.NewEvmClient(&globalConfig, sepoliaConfig, dbAdapter, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	bnbClient, err = evm.NewEvmClient(&globalConfig, bnbConfig, dbAdapter, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	os.Exit(m.Run())
}
func createDbAdapter() (*db.DatabaseAdapter, error) {
	dbAdapter, err := db.NewDatabaseAdapter(&globalConfig)
	if err != nil {
		log.Error().Msgf("failed to create db adapter: %v", err)
	}
	return dbAdapter, nil
}
func createEVMClient(key string) (*ethclient.Client, error) {
	rpcEndpoint := os.Getenv(key)
	rpcSepolia, err := rpc.DialContext(context.Background(), rpcEndpoint)
	if err != nil {
		fmt.Printf("failed to connect to sepolia with rpc %s: %v", rpcEndpoint, err)
		return nil, err
	}
	return ethclient.NewClient(rpcSepolia), nil
}
func TestSepoliaEstimateGas(t *testing.T) {
	sepoliaClient, err := evm.NewEvmClient(&globalConfig, sepoliaConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	transactOpts, err := evm.CreateTransactOpts(sepoliaConfig)
	if err != nil {
		log.Error().Msgf("failed to create transact opts: %v", err)
	}
	gatewayAddress := common.HexToAddress(sepoliaConfig.Gateway)
	hexData := strings.TrimPrefix(BIG_EXECUTE_DATA, "0x")
	data, err := hex.DecodeString(hexData)
	require.NoError(t, err)
	callMsg := ethereum.CallMsg{
		To:   &gatewayAddress,
		From: transactOpts.From,
		Data: data,
	}
	gas, err := sepoliaClient.Client.EstimateGas(context.Background(), callMsg)
	if err != nil {
		log.Error().Msgf("failed to estimate gas: %v", err)
	}
	t.Logf("gas: %v", gas)
	require.NoError(t, err)
	// err = ec.Client.SendTransaction(context.Background(), signedTx)
	// if err != nil {
	// 	return nil, fmt.Errorf("failed to send transaction: %w", err)
	// }
}
func TestSepoliaRecoverEvents(t *testing.T) {
	sepoliaClient, err := evm.NewEvmClient(&globalConfig, sepoliaConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	//Log missing logs
	go func() {
		scalarGatewayAbi, _ := contracts.IScalarGatewayMetaData.GetAbi()
		events := map[string]abi.Event{}
		for _, event := range scalarGatewayAbi.Events {
			events[event.ID.String()] = event
		}
		for !sepoliaClient.MissingLogs.IsRecovered() {
			logs := sepoliaClient.MissingLogs.GetLogs(10)
			for _, txLog := range logs {
				topic := txLog.Topics[0].String()
				event, ok := events[topic]
				if !ok {
					log.Error().Str("topic", topic).Any("txLog", txLog).Msg("[EvmClient] [ProcessMissingLogs] event not found")
					continue
				}
				log.Debug().
					Str("chainId", sepoliaClient.EvmConfig.GetId()).
					Str("eventName", event.Name).
					Str("txHash", txLog.TxHash.String()).
					Msg("[EvmClient] [ProcessMissingLogs] processing missing event")
			}
		}
		log.Info().Str("Chain", sepoliaClient.EvmConfig.ID).Msg("[EvmClient] [ProcessMissingLogs] finished processing all missing evm events")

	}()
	err = sepoliaClient.RecoverAllEvents(context.Background())
	require.NoError(t, err)
	select {}
}

func TestBnbRecoverEvents(t *testing.T) {
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	err = bnbClient.RecoverAllEvents(context.Background())
	require.NoError(t, err)
}

func TestEvmClientListenContractCallEvent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayContractCall)

	subContractCall, err := sepoliaClient.Gateway.WatchContractCall(&watchOpts, sink, nil, nil)
	if err != nil {
		log.Error().Err(err).Msg("ContractCallEvent")
	}
	if subContractCall != nil {
		log.Info().Msg("Subscribed to ContractCallEvent successfully.")
		go func() {
			log.Info().Msg("Waiting for events...")
			for event := range sink {
				log.Info().Any("event", event).Msgf("ContractCall")
			}
		}()
		go func() {
			errChan := subContractCall.Err()
			if err := <-errChan; err != nil {
				log.Error().Err(err).Msg("Received error")
			}
		}()
	}
	select {}
}

func TestEvmClientListenContractCallApprovedEvent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayContractCallApproved)

	subContractCallApproved, err := sepoliaClient.Gateway.WatchContractCallApproved(&watchOpts, sink, nil, nil, nil)
	if err != nil {
		log.Error().Err(err).Msg("ContractCallApprovedEvent")
	}
	if subContractCallApproved != nil {
		log.Info().Msg("Subscribed to ContractCallApprovedEvent successfully.")
		go func() {
			log.Info().Msg("Waiting for events...")
			for event := range sink {
				log.Info().Any("event", event).Msgf("ContractCallApproved")
			}
		}()
		go func() {
			errChan := subContractCallApproved.Err()
			if err := <-errChan; err != nil {
				log.Error().Err(err).Msg("Received error")
			}
			subContractCallApproved.Unsubscribe()
		}()
	}
	select {}
}
func TestEvmClientListenEVMExecutedEvent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayExecuted)

	subExecuted, err := sepoliaClient.Gateway.WatchExecuted(&watchOpts, sink, nil)
	if err != nil {
		log.Error().Err(err).Msg("ExecutedEvent")
	}
	if subExecuted != nil {
		log.Info().Msg("Subscribed to ExecutedEvent successfully. Waiting for events...")
		go func() {
			for event := range sink {
				log.Info().Any("event", event).Msgf("Executed")
			}
		}()
		go func() {
			errChan := subExecuted.Err()
			if err := <-errChan; err != nil {
				log.Error().Err(err).Msg("Received error")
			}
		}()
	}
	select {}
}
func TestRecoverEvent(t *testing.T) {
	fnCreateEventData := func(log types.Log) *contracts.IScalarGatewayContractCall {
		return &contracts.IScalarGatewayContractCall{
			Raw: log,
		}
	}
	err := evm.RecoverEvent[*contracts.IScalarGatewayContractCall](sepoliaClient, context.Background(), events.EVENT_EVM_CONTRACT_CALL, fnCreateEventData)
	require.NoError(t, err)
}
func TestEvmSubscribe(t *testing.T) {
	fmt.Println("Test evm client")

	// Connect to Ethereum client
	client, err := ethclient.Dial(sepoliaConfig.RPCUrl)
	require.NoError(t, err)
	if err != nil {
		fmt.Printf("failed to connect to the Ethereum client: %v", err)
	}

	// Get current block
	currentBlock, err := client.BlockNumber(context.Background())
	require.NoError(t, err)
	if err != nil {
		fmt.Printf("failed to get current block: %v", err)
	}
	fmt.Printf("Current block %d\n", currentBlock)

	// Create the event signature
	contractCallSig := []byte("ContractCall(address,string,string,bytes32,bytes)")

	// Create the filter query
	query := ethereum.FilterQuery{
		Addresses: []common.Address{common.HexToAddress(sepoliaConfig.Gateway)},
		Topics: [][]common.Hash{{
			crypto.Keccak256Hash(contractCallSig),
		}},
	}

	// Subscribe to events
	logs := make(chan types.Log)
	sub, err := client.SubscribeFilterLogs(context.Background(), query, logs)
	require.NoError(t, err)
	if err != nil {
		fmt.Printf("failed to subscribe to logs: %v", err)
	}

	// Handle events in a separate goroutine
	go func() {
		for {
			select {
			case err := <-sub.Err():
				fmt.Printf("Received error: %v", err)
			case vLog := <-logs:
				fmt.Println("Log:", vLog)
			}
		}
	}()

	// Keep the program running
	select {}
}
func TestRecoverEventTokenSent(t *testing.T) {
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	require.NoError(t, err)
	//Get current block number
	blockNumber, err := bnbClient.Client.BlockNumber(context.Background())
	require.NoError(t, err)
	lastCheckpoint := scalarnet.EventCheckPoint{
		ChainName:   bnbConfig.ID,
		EventName:   events.EVENT_EVM_TOKEN_SENT,
		BlockNumber: blockNumber - 10000,
		TxHash:      "",
		LogIndex:    0,
		EventKey:    "",
	}
	missingEvents, err := evm.GetMissingEvents[*contracts.IScalarGatewayTokenSent](bnbClient, events.EVENT_EVM_TOKEN_SENT,
		&lastCheckpoint, func(log types.Log) *contracts.IScalarGatewayTokenSent {
			return &contracts.IScalarGatewayTokenSent{
				Raw: log,
			}
		})
	require.NoError(t, err)
	fmt.Printf("missingEvents %v\n", missingEvents)
}
func TestRecoverEventContractCallWithToken(t *testing.T) {
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	require.NoError(t, err)
	//Get current block number
	blockNumber, err := bnbClient.Client.BlockNumber(context.Background())
	fmt.Printf("blockNumber %v\n", blockNumber)
	require.NoError(t, err)
	lastCheckpoint := scalarnet.EventCheckPoint{
		ChainName:   bnbConfig.ID,
		EventName:   events.EVENT_EVM_CONTRACT_CALL_WITH_TOKEN,
		BlockNumber: bnbConfig.LastBlock,
		TxHash:      "",
		LogIndex:    0,
		EventKey:    "",
	}
	missingEvents, err := evm.GetMissingEvents[*contracts.IScalarGatewayContractCallWithToken](bnbClient, events.EVENT_EVM_CONTRACT_CALL_WITH_TOKEN,
		&lastCheckpoint, func(log types.Log) *contracts.IScalarGatewayContractCallWithToken {
			return &contracts.IScalarGatewayContractCallWithToken{
				Raw: log,
			}
		})
	require.NoError(t, err)
	fmt.Printf("%d missing events found\n", len(missingEvents))

	txHash := "0xc7d4fac102169c129a4f04ccd4e3fa17fcd962f137e4928fb2462c52da039899"
	tx, isPending, err := bnbClient.Client.TransactionByHash(context.Background(), common.HexToHash(txHash))
	fmt.Printf("tx %v\n", tx)
	fmt.Printf("isPending %v\n", isPending)
	fmt.Printf("err %v\n", err)
	txHash = "1c9623e21b55e9c4767a12b27f9f68578c167284651efb2b87a51ce438e9fa53"
	tx, isPending, err = bnbClient.Client.TransactionByHash(context.Background(), common.HexToHash(txHash))
	require.NoError(t, err)
	fmt.Printf("tx %v\n", tx)
	fmt.Printf("isPending %v\n", isPending)
	fmt.Printf("err %v\n", err)

	log.Info().Str("txHash", txHash).Any("tx", tx).Msgf("ContractCallWithToken")
	for _, event := range missingEvents {
		receipt, err := bnbClient.Client.TransactionReceipt(context.Background(), common.HexToHash(event.Hash))
		require.NoError(t, err)
		log.Info().Str("txHash", event.Hash).Any("receipt", receipt).Msgf("ContractCallWithToken")
	}
}

func TestEvmClientWatchTokenSent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayTokenSent)
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	subscription, err := bnbClient.Gateway.WatchTokenSent(&watchOpts, sink, nil)
	require.NoError(t, err)
	defer subscription.Unsubscribe()
	log.Info().Msgf("[EvmClient] [watchEVMTokenSent] success. Listening to TokenSent")

	for {
		select {
		case err := <-subscription.Err():
			log.Error().Msgf("[EvmClient] [watchEVMTokenSent] error: %v", err)
		case event := <-sink:
			log.Info().Any("event", event).Msgf("EvmClient] [watchEVMTokenSent]")
		}
	}
}
func TestSendTokenFromSepoliaToBnb(t *testing.T) {
	fmt.Println("Test SendToken From Sepolia to BnB")
	fmt.Printf("DestChain %s, TokenSymbol %s, UserAddress %s", CHAIN_ID_BNB, TOKEN_SYMBOL, evmUserAddress)
	sepoliaGwAddr := "0x842C080EE1399addb76830CFe21D41e47aaaf57e"
	amount := big.NewInt(10000)

	sepoliaGateway, _, err := evm.CreateGateway("Sepolia", sepoliaGwAddr, sepoliaEthClient)
	assert.NoError(t, err)
	sepoliaConfig.PrivateKey = evmUserPrivKey
	fmt.Printf("SepoliaConfig %v\n", sepoliaConfig)
	transOpts, err := evm.CreateTransactOpts(sepoliaConfig)
	assert.NoError(t, err)
	//Need to incrate allowance if need
	// tokenAddress := "0x6e3B806C5F6413e0a0670666301ccB6b10628A52"
	// proxy, err := createErc20ProxyContract(tokenAddress, sepoliaClient)
	// assert.NoError(t, err)
	// allowance, err := proxy.Allowance(callOpts, common.HexToAddress(evmUserAddress), common.HexToAddress(sepoliaGwAddr))
	// assert.NoError(t, err)
	// if allowance.Int64() < amount.Int64() {
	// 	proxy.IncreaseAllowance(transOpts, common.HexToAddress(sepoliaGwAddr), amount)
	// }
	time.Sleep(15 * time.Second)
	tx, err := sepoliaGateway.SendToken(transOpts, CHAIN_ID_BNB, evmUserAddress, TOKEN_SYMBOL, amount)
	assert.NoError(t, err)
	fmt.Printf("SendToken tx %v\n", tx)
}
func TestReconnectWithWatchTokenSent(t *testing.T) {
	watchOpts := bind.WatchOpts{Start: &sepoliaConfig.LastBlock, Context: context.Background()}
	sink := make(chan *contracts.IScalarGatewayTokenSent)
	bnbClient, err := evm.NewEvmClient(&globalConfig, bnbConfig, nil, nil, nil)
	if err != nil {
		log.Error().Msgf("failed to create evm client: %v", err)
	}
	subscription, err := bnbClient.Gateway.WatchTokenSent(&watchOpts, sink, nil)
	require.NoError(t, err)
	defer subscription.Unsubscribe()
	log.Info().Msgf("[EvmClient] [watchEVMTokenSent] success. Listening to TokenSent")
	done := false
	for !done {
		select {
		case err := <-subscription.Err():
			log.Error().Err(err).Msg("[EvmClient] [watchEVMTokenSent] error with subscription, perform reconnect")
			subscription, err = bnbClient.Gateway.WatchTokenSent(&watchOpts, sink, nil)
			require.NoError(t, err)
		case <-watchOpts.Context.Done():
			log.Info().Msgf("[EvmClient] [watchEVMTokenSent] context done")
			done = true
		case event := <-sink:
			log.Info().Any("event", event).Msgf("EvmClient] [watchEVMTokenSent]")
		}
	}
}
func createErc20ProxyContract(proxyAddress string, client *ethclient.Client) (*contracts.IScalarERC20CrossChain, error) {
	proxy, err := contracts.NewIScalarERC20CrossChain(common.HexToAddress(proxyAddress), client)
	if err != nil {
		return nil, fmt.Errorf("failed to initialize proxy contract from address: %s", proxyAddress)
	}
	return proxy, nil
}
