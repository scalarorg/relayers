package scalar_test

import (
	"encoding/base64"
	"fmt"
	"strconv"
	"testing"

	"github.com/scalarorg/relayers/pkg/clients/scalar"
	"github.com/scalarorg/scalar-core/x/chains/types"
	chainstypes "github.com/scalarorg/scalar-core/x/chains/types"
	"github.com/stretchr/testify/assert"
)

var (
	batchCommandResponse types.BatchedCommandsResponse
)

func TestParseBatchCommandResponse(t *testing.T) {
	batchCommandResponse = types.BatchedCommandsResponse{
		ID:                    "4232f0de2c89b385257558608e4f57d67b186281555a9b7bc9b0db63ab1840ec",
		Data:                  "0000000000000000000000000000000000000000000000000000000000aa36a7000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000183870a87712fc1bf2b53957975872b4fece9975671207ce90fd8b4f9c7abb49d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000b6465706c6f79546f6b656e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000005f5e1000000000000000000000000006e3b806c5f6413e0a0670666301ccb6b10628a5200000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000004704274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047042746300000000000000000000000000000000000000000000000000000000",
		ExecuteData:           "09c5eabe000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006800000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000aa36a7000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000183870a87712fc1bf2b53957975872b4fece9975671207ce90fd8b4f9c7abb49d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000b6465706c6f79546f6b656e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000005f5e1000000000000000000000000006e3b806c5f6413e0a0670666301ccb6b10628a5200000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000004704274630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000047042746300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000177000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000400000000000000000000000003e7526e6a9240a631c0de6882791c06348146360000000000000000000000007a493be0af048a8d31c56c2221a7531f1a9d849500000000000000000000000092b198ca6be0a68b99b0aeb061ba17d7e8625e10000000000000000000000000941724a52ae98e1777532cd608821ad68cdce1f3000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000003e80000000000000000000000000000000000000000000000000000000000000fa00000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000000000000000000000000000000000000000007d00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000041b29e9b9f42d6cff9c2e9708ccb5a200786f63cfccb4954561484415c9b9353cd78be93189cdb81f74bf282642f73bdf824abacf5e926736c6fbd75c2d559871e1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004118ab57bedac1a9eda7fca92a5219c21fa2d25d3d4bc13cc2e18b458229090ad128d957711ace83990be224065f3b031e42bdda060eb2d2cb6ad76d700b211d341b00000000000000000000000000000000000000000000000000000000000000",
		Status:                types.BatchedCommandsStatus(3),
		KeyID:                 "evm|11155111",
		PrevBatchedCommandsID: "",
		CommandIDs:            []string{"83870a87712fc1bf2b53957975872b4fece9975671207ce90fd8b4f9c7abb49d"},
		Proof: &types.Proof{
			Addresses:  []string{"0x03e7526E6A9240A631c0dE6882791C0634814636", "0x7a493be0af048a8D31c56C2221a7531f1a9D8495", "0x92B198Ca6Be0A68B99b0AEB061bA17d7E8625e10", "0x941724a52aE98e1777532cd608821AD68CDCe1F3"},
			Signatures: []string{"b29e9b9f42d6cff9c2e9708ccb5a200786f63cfccb4954561484415c9b9353cd78be93189cdb81f74bf282642f73bdf824abacf5e926736c6fbd75c2d559871e1b", "18ab57bedac1a9eda7fca92a5219c21fa2d25d3d4bc13cc2e18b458229090ad128d957711ace83990be224065f3b031e42bdda060eb2d2cb6ad76d700b211d341b"},
			Threshold:  "6000",
			Weights:    []string{"1000", "4000", "3000", "2000"},
		},
	}
}

func TestParseCommand(t *testing.T) {
	payloadBase64 := "AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAo5wc2J0/wEAawIAAAABnXmsN2JCjow3uMBIXpg/cFRe31PGKe+bPihO8j5PiqwAAAAAAP3///8CAAAAAAAAAAAQag5TQ0FMQVIBAUF0cmFuc+UCAAAAAAAAFgAUUNzsoVipyHLrQF1SKT01ERBXLJ4AAAAAAAEBK+gDAAAAAAAAIlEgnsjcFImQIAcFuX1u4gE2KTbX+c6Akmx6PhvbMzgq7aYBAwQAAAAAQRQq4x6ocJrtqBlLo+L35+leaA6LZRNciYPAopjRe8U1Crg1xtxKn6bpa69fUZIkTcDQy2EOb7g4xBn/3dAO/qt6QKiQtF02sgenz5bAkgecYaZnq7IXpXobTiBM0bBIwL+K7wg9SQ+eg80Ghb/JKk+Ux6caH8zH+6d7zsxe9aEuIYdCFcFQkpt0waBJVLeLS2A16XpeB4paDyjsltVHv+6azoA6wD+EUDDdqFbjF9sKDQ2ngAYKrc/7N26LJJGkq5CEKr82RSAq4x6ocJrtqBlLo+L35+leaA6LZRNciYPAopjRe8U1Cq0gqaPslqEFExCoDqnqrtVsxotdfb48qm8UUBTaiLiX6fqswCEWKuMeqHCa7agZS6Pi9+fpXmgOi2UTXImDwKKY0XvFNQolAbg1xtxKn6bpa69fUZIkTcDQy2EOb7g4xBn/3dAO/qt6AAAAACEWqaPslqEFExCoDqnqrtVsxotdfb48qm8UUBTaiLiX6folAbg1xtxKn6bpa69fUZIkTcDQy2EOb7g4xBn/3dAO/qt6AAAAAAEXIFCSm3TBoElUt4tLYDXpel4HiloPKOyW1Ue/7prOgDrAARggTmxauhABZ7E6eikbCa107OE6VK0/kg4EOPYVbEfkqGAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
	payload, err := base64.StdEncoding.DecodeString(payloadBase64)
	assert.NoError(t, err)
	amount, err := strconv.ParseUint("10000", 10, 64)
	assert.NoError(t, err)
	fmt.Printf("amount: %d\n", amount)
	commandResponse := chainstypes.QueryCommandResponse{
		Params: map[string]string{
			"amount": "10000",
		},
		Payload: payload,
	}
	commandOutPoint, err := scalar.TryExtractCommandOutPoint(commandResponse)
	assert.NoError(t, err)
	assert.Equal(t, uint64(10000), commandOutPoint.OutPoint.Amount)
}
